---
# Configuration ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: aiplatform-config
  namespace: aiplatform
  labels:
    app: aiplatform
data:
  # Application Configuration
  app.yaml: |
    app:
      name: "AI Platform SDK"
      version: "1.0.0"
      environment: "production"
      debug: false
      
      api:
        host: "0.0.0.0"
        port: 8000
        workers: 4
        timeout: 120
        
      quantum:
        backend: "qiskit"
        simulator: "qasm_simulator"
        
      mesh:
        max_nodes: 100
        sync_interval: 30
        
      security:
        jwt_expiry: 3600
        rate_limit: 1000
        
  # Logging Configuration
  logging.yaml: |
    version: 1
    disable_existing_loggers: false
    formatters:
      standard:
        format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
      json:
        format: '{"timestamp": "%(asctime)s", "level": "%(levelname)s", "message": "%(message)s"}'
    
    handlers:
      console:
        class: logging.StreamHandler
        level: DEBUG
        formatter: standard
        stream: ext://sys.stdout
      
      file:
        class: logging.handlers.RotatingFileHandler
        level: INFO
        formatter: json
        filename: /var/log/aiplatform/app.log
        maxBytes: 10485760
        backupCount: 5
    
    root:
      level: INFO
      handlers: [console, file]
  
  # Prometheus Metrics Configuration
  prometheus.yaml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    
    scrape_configs:
    - job_name: 'aiplatform'
      static_configs:
      - targets: ['localhost:8001']
      relabel_configs:
      - source_labels: [__address__]
        target_label: instance
  
  # Nginx Configuration for reverse proxy
  nginx.conf: |
    worker_processes auto;
    events {
      worker_connections 1024;
    }
    
    http {
      upstream aiplatform_api {
        least_conn;
        server aiplatform-api:8000 max_fails=3 fail_timeout=30s;
      }
      
      upstream mesh_worker {
        least_conn;
        server aiplatform-mesh-worker:8000;
      }
      
      server {
        listen 80;
        server_name _;
        
        location / {
          proxy_pass http://aiplatform_api;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_connect_timeout 60s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;
        }
        
        location /mesh {
          proxy_pass http://mesh_worker;
          proxy_set_header Host $host;
        }
        
        location /metrics {
          proxy_pass http://aiplatform_api:8001/metrics;
        }
      }
    }
  
  # Database Migration Configuration
  alembic.ini: |
    sqlalchemy.url = 
    
    script_location = alembic
    sqlalchemy.echo = false
    sqlalchemy.track_modifications = false
    
  # Redis Configuration
  redis.conf: |
    bind 0.0.0.0
    port 6379
    databases 16
    
    save 900 1
    save 300 10
    save 60 10000
    
    appendonly yes
    appendfsync everysec
    
    maxmemory 2gb
    maxmemory-policy allkeys-lru
    
    timeout 0
    tcp-keepalive 300
    
    loglevel notice
    logfile /var/log/redis/redis.log
    
    # Replication
    repl-diskless-sync no
    repl-diskless-sync-delay 5
    
    # Security
    requirepass ${REDIS_PASSWORD}
